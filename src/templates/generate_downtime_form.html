{% extends "base.html.j2" %}
{% if form.resource.data %}
{% set opts_disabled = false %}
{% else %}
{% set opts_disabled = true %}
{% endif %}
{% macro render_dtfield(field) %}
{{ macros.render_field(field, disabled=opts_disabled, **kwargs) }}
{% endmacro %}

{% set downtime_fieldnames = [
  "scheduled", "description", "severity", "start_date", "start_time",
  "end_date", "end_time", "services", "generate"] %}
{% block title %}Downtime YAML generator{% endblock %}

{% block content %}
<center><h3>Downtime YAML generator</h3></center>
<div class="container">
  <div class="row">
    <div class="col-sm">
      <form method=post>
        <!-- NOTE: we are not using CSRF because none of the POST data is actually
        used to change anything.  If that ever changes, see
        https://flask-wtf.readthedocs.io/en/stable/csrf.html
        -->
        {{ macros.render_field(form.facility) }}
        {{ macros.render_field(form.change_facility, show_label=false) }}
        {{ macros.render_field(form.resource) }}
        {{ macros.render_field(form.change_resource, show_label=false) }}

        {{ render_dtfield(form.scheduled) }}
        {{ render_dtfield(form.description) }}
        {{ render_dtfield(form.severity) }}

        <div class="form-row">
          {{ render_dtfield(form.start_date, type="date", show_label=true) }}
          {{ render_dtfield(form.start_time, type="time", show_label=true) }}
        </div>
        <div class="form-row">
          {{ render_dtfield(form.end_date, type="date", show_label=true) }}
          {{ render_dtfield(form.end_time, type="time", show_label=true) }}
        </div>
        {{ render_dtfield(form.services) }}
        <button type="submit" class="btn btn-primary">Generate</button>
      </form>
    </div>
    <div class="col-sm">
      {% if yaml -%}
        <ol>
          {% if site_dir_url -%}
            {% if edit_url -%}
              <li><a href="{{ edit_url }}" target="_blank">Click here to edit the downtime file on GitHub.</a></li>
            {% else -%}
              <li><a href="{{ site_dir_url }}" target="_blank">Click here to open the site directory on GitHub.</a></li>
              <li>
                Click the "Create new file" button and name the file:
                <pre>"{{ filename }}"</pre>
              </li>
            {% endif -%}
          {% else -%}
            <li>
              In your topology repo checkout, open the file named:
              <pre>"{{ filepath }}"</pre>
            </li>
          {% endif -%}
          <li>
            Copy-and-paste the following YAML as-is to the end:<br/>
            {{ macros.render_field(form.yamloutput, show_label=false) }}
          </li>
        </ol>
      {% else %}{# yaml #}
        YAML code will be displayed here:<br/>
        {{ macros.render_field(form.yamloutput, show_label=false) }}
      {% endif %}
    </div><!-- col-sm -->
  </div><!-- row -->
</div><!-- container -->
{% endblock %}
{% block last %}
<script type="text/javascript">
  $( "#facility" ).change( function () {
    {% for fieldname in [ "resource", "change_resource" ] + downtime_fieldnames %}
    $( "#{{ fieldname }}" ).prop("disabled", true);
    {% endfor %}
    $( "#change_facility" ).click();
  } );
  $( "#resource" ).change( function() {
    {% for fieldname in downtime_fieldnames %}
    $( "#{{ fieldname }}" ).prop("disabled", true);
    {% endfor %}
    $( "#change_resource" ).click();
  } );
</script>
{% endblock %}